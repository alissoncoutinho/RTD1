@model IEnumerable<Barragem.Models.InscricaoTorneio>
    @{
        Layout = "~/Views/Shared/_LayoutTorneio2.cshtml";
    }
    <section class="content">
        <div class="row">
            <div class="col-md-6">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">Escolha sua Dupla</h3>
                    </div>
                    <div class="box-body">
                        @if (ViewBag.classe1!=null){ 
                        <div class="form-horizontal">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">Classes</label>
                                <div class="col-sm-4 input-group">
                                    <select name="classe" id="classe" class="form-control" onchange="Selecionar()">
                                        <option value="@ViewBag.classe1" @if (ViewBag.classe1 == 1){ @Html.Raw("selected") }>@ViewBag.classe1Nome</option>
                                        <option value="@ViewBag.classe2" @if (ViewBag.classe2 == 1) { @Html.Raw("selected")  }>@ViewBag.classe2Nome</option>
                                    </select>
                                    <input type="hidden" value="" name="torneioId" id="torneioId">
                                </div>
                            </div>
                        </div>
                        }
                        @if (Model == null)
                        {
                            <p>Desculpe, mas não encontramos nenhuma inscrição ativa de classe de dupla no seu login.</p>
                        }else{
                            if (ViewBag.isDisponivel)
                            {
                                <small>Clique no botão "Escolher" ao lado do nome do seu parceiro para selecioná-lo como sua dupla.</small>
                            }   
                            else
                            {
                                <small>Você já possui parceiro de dupla, caso queira mudar de parceiro, favor entrar em contato com o organizador do torneio.</small>
                            }
                         
                            <table class="table table-striped table-condensed table-bordered">
                                <tr>
                                    <th>
                                        @Html.DisplayName("Nome")
                                    </th>
                                    <th>
                                        @Html.DisplayName("Dupla")
                                    </th>
                                </tr>
                                @foreach (var item in Model)
                                {
                                    <tr @if (item.participante.UserId == WebSecurity.GetUserId(User.Identity.Name) || (item.parceiroDupla != null && item.parceiroDupla.UserId == WebSecurity.GetUserId(User.Identity.Name))) { @Html.Raw("style='color:green; font-weight: bold;'")   }>
                                        <td>
                                            @Html.Raw(item.participante.nome)
                                        </td>
                                        <td id="@Html.Raw("escolhaTd"+item.Id)">
                                            @if (item.parceiroDupla != null)
                                            {
                                                @item.parceiroDupla.nome
                                            }
                                            else if (!ViewBag.isDisponivel)
                                            {
                                                @Html.Raw("")
                                            }
                                            else
                                            {
                                                <button title="Escolher dupla" data-torneio="@item.torneioId" data-valor="@item.Id" data-nome="@item.participante.nome" data-fone="@item.participante.telefoneCelular"
                                                        name="@Html.Raw("button"+item.Id)" id="@Html.Raw("button" + item.Id)" class="col-lg-12 col-xs-12 btn btn-primary btn-xs confirmEscolha">
                                                    Escolher
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </table>
                        }
                    </div>
                </div>
            </div>
        </div>
    </section>
    @section Scripts {
        <script type="text/javascript">
            $(document).ready(function () {
                $(".confirmEscolha").click(function (event) {
                    event.preventDefault();
                    var id = $(this).data("valor");
                    var participante = $(this).data("nome");
                    var fone = $(this).data("fone");
                    var torneio = $(this).data("torneio");
                    $.confirm({
                        title: "Importante",
                        text: "Você está escolhendo <b>" + participante + "</b>, telefone <b>" + fone + "</b> como sua dupla. <b>Deseja prosseguir?</b> Após esta escolha, apenas o organizador poderá alterar sua dupla.",
                        confirm: function (button) {
                            $.ajax({
                                type: "POST",
                                url: "/Torneio/EscolherDupla",
                                dataType: "json",
                                data: "{'inscricaoJogador':'" + id + "', 'torneioId':'" + torneio + "'}",
                                contentType: "application/json; charset=utf-8",
                                success: function (response) {
                                    if (typeof response == "object") {
                                        if (response.retorno === 0) {
                                            toastr.error(response.erro, "Erro");
                                        } else {
                                            $('#escolhaTd' + id).html('<small style="color:green;"><b>Parceiro Escolhido</b></small>');
                                            toastr.success("Escolha realizada com sucesso.", "Aviso");
                                        }
                                    }
                                },
                                error: function (jqXHR, textStatus, errorThrown) {
                                    location.reload(true);
                                }
                            });
                        },
                        cancel: function (button) {

                        },
                        confirmButton: "Sim",
                        cancelButton: "Não"
                    });

                });




            });

        </script>
    }

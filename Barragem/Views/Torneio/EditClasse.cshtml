@{
    int i = 0;
    int qtddClasses = Model.Count();
}
@model IEnumerable<Barragem.Models.ClasseTorneio>
    @Html.Partial("_PartialTabs")

    <div class="tab-content">
        <div class="tab-pane fade" id="tabCadastro"></div>
        <div class="tab-pane fade" id="tabInscritos"></div>
        <div class="tab-pane fade" id="tabJogos"></div>
        <div class="tab-pane fade" id="tabDuplas"></div>
        <div class="tab-pane fade in active" id="tabEditClasses">
            <br>
            <p>
                <a href="@Url.Action("CreateClasse", new {torneioId = ViewBag.TorneioId, qtddClasses = qtddClasses })" class="btn btn-primary btn-small"><span class="glyphicon glyphicon-plus"></span> Nova</a>
            </p>
            @using (Html.BeginForm("EditOrdemExibicaoClasse", "Torneio", FormMethod.Post, new { @class = "form-horizontal" }))
            {
                <div class="box-body table-responsive no-padding">
                    <table class="table table-striped table-condensed table-bordered">
                        <tr>
                            <th>
                                <b>Ordem Exibição</b>
                            </th>
                            @if (ViewBag.isLiga)
                            {
                                <th>
                                    @Html.DisplayName("Nome categoria no circuito")
                                </th>
                            }
                            <th>
                                @Html.DisplayName("Nome categoria no Torneio")
                            </th>
                            @if (ViewBag.temLimiteDeInscricao != null && (bool)ViewBag.temLimiteDeInscricao)
                            {
                                <th>
                                    @Html.DisplayName("Limite inscrição")
                                </th>
                            }
                            <th>
                                @Html.DisplayName("Dupla")
                            </th>
                            @if (!ViewBag.isModeloTodosContraTodos)
                            {
                                <th>
                                    @Html.DisplayName("Fase Grupo")
                                </th>
                                <th>
                                    @Html.DisplayName("Mata-Mata")
                                </th>
                            }
                            <th></th>
                        </tr>
                        @foreach (var item in Model)
                        {
                            i++;
                            <tr id="@item.Id">
                                <td>
                                    <select name="ordemExibicao">
                                        @for (int j = 1; j <= Model.Count(); j++)
                                        {
                                            <option @if (item.nivel == j) { @Html.Raw(" selected ") }>@j</option>
                                        }
                                    </select>
                                </td>
                                @if (ViewBag.isLiga)
                                {
                                    <th>
                                        @if (@item.Categoria != null)
                                        {
                                            @Html.Raw(item.Categoria.Nome)
                                        }
                                        else
                                        {
                                            @Html.Raw("não pontua para circuito")

                                            <button type="button" id="@Html.Raw("btnEditCatCircuito"+ item.Id)" class="btn btn-info btn-xs"
                                                    data-toggle="modal" data-target="#modalEditCatCircuito" onclick="abrirModalEditCatCircuito(@item.Id, @ViewBag.TorneioId)">
                                                <span class="glyphicon glyphicon-edit"></span>
                                            </button>
                                        }
                                    </th>
                                }
                                <td>
                                    <input type="text" class="col-md-6 form-control" name="@Html.Raw("nome" + i)" id="@Html.Raw("nome" + i)" value="@item.nome">
                                </td>
                                @if (ViewBag.temLimiteDeInscricao != null && (bool)ViewBag.temLimiteDeInscricao)
                                {
                                    <td>
                                        <input type="text" class="col-md-6 form-control" name="@Html.Raw("maximoInscritos" + i)" id="@Html.Raw("maximoInscritos" + i)" value="@item.maximoInscritos">
                                    </td>
                                }
                                else
                                {
                                    <input type="hidden" name="@Html.Raw("maximoInscritos" + i)" id="@Html.Raw("maximoInscritos" + i)" value="@item.maximoInscritos" />
                                }
                                <td>
                                    @if (item.isDupla)
                                    {
                                        <input type="checkbox" checked value="true" name="@Html.Raw("isDupla" + i)" id="@Html.Raw("isDupla" + i)" />
                                    }
                                    else
                                    {
                                        <input type="checkbox" value="true" name="@Html.Raw("isDupla" + i)" id="@Html.Raw("isDupla" + i)" />
                                    }
                                </td>
                                @if (!ViewBag.isModeloTodosContraTodos)
                                {
                                    <td>
                                        @if (item.faseGrupo)
                                        {
                                            <input type="checkbox" checked value="true" name="@Html.Raw("faseGrupo" + i)" id="@Html.Raw("faseGrupo" + i)" />
                                        }
                                        else
                                        {
                                            <input type="checkbox" value="true" name="@Html.Raw("faseGrupo" + i)" id="@Html.Raw("faseGrupo" + i)" />
                                        }
                                    </td>
                                    <td>
                                        @if (item.faseMataMata)
                                        {
                                            <input type="checkbox" checked value="true" name="@Html.Raw("faseMataMata" + i)" id="@Html.Raw("faseMataMata" + i)" />
                                        }
                                        else
                                        {
                                            <input type="checkbox" value="true" name="@Html.Raw("faseMataMata" + i)" id="@Html.Raw("faseMataMata" + i)" />
                                        }
                                    </td>
                                }
                                <td align="center">
                                    <form method="post" enctype="multipart/form-data" action="#" name="@Html.Raw("form" + i)" id="@Html.Raw("form" + i)" class="form">
                                        <button title="salvar" data-valor="@Html.Raw(i)" data-ident="@item.Id" name="@Html.Raw("button" + i)" id="@Html.Raw("button" + i)" class="btn btn-default btn-xs inscricaoButton">
                                            Salvar
                                        </button>
                                        <button title="excluir" data-valor="@item.Id" name="@Html.Raw("buttonEx" + i)" id="@Html.Raw("buttonEx" + i)" class="btn btn-danger btn-xs excluirButton">
                                            Excluir
                                        </button>
                                    </form>
                                </td>

                            </tr>
                        }
                    </table>
                </div>
                <p>
                    <input type="hidden" name="torneioId" value="@ViewBag.TorneioId" />
                    <button class="btn btn-cta-secondary btn-small" type="submit">Salvar ordem de exibição</button>
                </p>
            }
        </div>
    </div>

    <div id="modalEditCatCircuito" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="padding:5px">
                    <a class="close" data-dismiss="modal">×</a>
                    <h3>Selecione a categoria no circuito que deseja vincular</h3>
                </div>
                <form id="formEditCatCircuito" role="form" method="post">
                    <div class="modal-body">
                        <div class="form-group">
                            <input type="hidden" id="idTorneio" class="form-control">
                            <input type="hidden" id="idClasse" class="form-control">
                        </div>

                        <select id="CategoriaId" name="CategoriaId" class="form-control">
                            <option value="0">SELECIONE</option>
                            @foreach (var categoria in ViewBag.Categorias)
                            {
                                <option value="@categoria.id">@categoria.label</option>
                            }
                        </select>

                    </div>
                    <div class="modal-footer">

                        <div style="display: inline-block; float: right;" class="col-md-6">
                            <button type="button" class="btn btn-default" data-dismiss="modal"><span class="spinner-border spinner-border-sm"></span>Cancelar</button>
                            <input type="button" value="Salvar" class="btn btn-primary" id="btnAlterarCategoriaCircuito" />
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    @section Scripts {
        <script type="text/javascript">
            $(document).ready(function () {
                $(".inscricaoButton").click(function (event) {
                    var i = $(this).data("valor");
                    var Id = $(this).data("ident");
                    var nome = document.getElementById("nome" + i).value;
                    var maximoInscritos = document.getElementById("maximoInscritos" + i).value;
                    var isDupla = document.getElementById("isDupla" + i).checked;
                    var faseGrupo = false;
                    var faseMataMata = false;
                    var isModeloTodosContraTodos = false;
                    try {
                        faseGrupo = document.getElementById("faseGrupo" + i).checked;
                        faseMataMata = document.getElementById("faseMataMata" + i).checked;
                    } catch (err) {
                        isModeloTodosContraTodos = true;
                    }
                    event.preventDefault();
                    $.ajax({
                        type: "POST",
                        url: "/Torneio/EditClasse",
                        dataType: "json",
                        data: "{'Id':'" + Id + "', 'nome':'" + nome + "', 'isDupla':'" + isDupla + "', 'faseGrupo':'" + faseGrupo + "', 'faseMataMata':'" + faseMataMata + "', 'isModeloTodosContraTodos':'" + isModeloTodosContraTodos + "', 'maximoInscritos':'" + maximoInscritos + "'}",
                        contentType: "application/json; charset=utf-8",
                        success: function (response) {
                            if (typeof response == "object") {
                                if (response.retorno === 0) {
                                    toastr.error(response.erro, "Erro");
                                } else {
                                    toastr.options = {
                                        "positionClass": "toast-top-center"
                                    }
                                    toastr.success("Atualização realizada com sucesso.", "Aviso");
                                }
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            location.reload(true);
                        }
                    });
                });

                $(".excluirButton").confirm({
                    title: "Confirmação",
                    content: "Tem certeza que deseja excluir esta classe?",
                    buttons: {
                        sim: {
                            text: 'Sim',
                            btnClass: 'btn-primary',
                            action: function () {
                                var Id = this.$target.data("valor");
                                event.preventDefault();
                                $.ajax({
                                    url: "/Torneio/ExcluirClasse?Id=" + Id,
                                    dataType: "json",
                                    contentType: "application/json; charset=utf-8",
                                    success: function (response) {
                                        if (typeof response == "object") {
                                            if (response.retorno === 0) {
                                                toastr.error(response.erro, "Erro");
                                            } else {
                                                $("#" + Id).remove();
                                                toastr.success("Exlusão realizada com sucesso.", "Aviso");
                                            }
                                        }
                                    },
                                    error: function (jqXHR, textStatus, errorThrown) {
                                        toastr.error(textStatus, "Erro");
                                    }
                                });
                            }
                        },
                        cancelar: function () { },
                    }
                });

                $("#btnAlterarCategoriaCircuito").click(function (event) {
                    event.preventDefault();

                    if ($("#CategoriaId").val() == 0) {
                        toastr.warning("Selecione uma categoria", "Aviso");
                    }

                    $.ajax({
                        type: "POST",
                        url: "/Torneio/AlterarCategoriaCircuitoClasse",
                        cache: false,
                        dataType: "json",
                        data: {
                            idClasse: $("#idClasse").val(),
                            idTorneio: $("#idTorneio").val(),
                            idCategoria: $("#CategoriaId").val()
                        },
                        success: function (response) {
                            toastr.success("Alteração realizada com sucesso.", "Aviso");
                            $("#modalEditCatCircuito").modal('hide');
                            window.location.href = response.redirectToUrl;
                        }
                    });

                });
            });

            function abrirModalEditCatCircuito(idClasse, idTorneio) {
                $("#idTorneio").val(idTorneio);
                $("#idClasse").val(idClasse);
            }

        </script>
    }
